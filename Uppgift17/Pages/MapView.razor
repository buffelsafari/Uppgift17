@inject IJSRuntime JS

@using Models
@using ViewEntity


<canvas @ref="canvas" @onclick="OnClick" @onmousemove="OnMouseMove" @onmousewheel="OnMouseWheel" @onmousedown="OnMouseDown" style="background-color: black; width: 100vw; height: 100vh; overflow:hidden;">
</canvas>

<button class="btn btn-danger" style="position:absolute; left:0; top:0;">hello</button>
@code 
{
    [CascadingParameter]
    protected Task<IEnumerable<DrawOperation>> DrawOps { get; set; }

    [Parameter]
    public Action<string> OnMachineClick { get; set; }

    private ElementReference canvas;
    private List<DrawOperation> drawList = new List<DrawOperation>();
    private double zoom = 1;
    private double rotation = 0;
    private double mouseDownX = 0;
    private double mouseDownY = 0;

    private double transX = 0;
    private double transY = 0;

    private bool isClicked = false;
    private double clickX=0;
    private double clickY=0;
    private bool isMoving = false;

    //private Entity baseEntity;


    protected async override Task OnParametersSetAsync()
    {
        Console.WriteLine("parameters set---------------------------------------------------");
        await JS.InvokeVoidAsync("RequestAnimationFrame", DotNetObjectReference.Create(this), "Redraw", canvas);
        base.OnParametersSet();
    }


    protected override async Task OnInitializedAsync()
    {

        await JS.InvokeVoidAsync("AddResizeListener", DotNetObjectReference.Create(this), "OnResize", canvas);
        //await JS.InvokeVoidAsync("RequestAnimationFrame", DotNetObjectReference.Create(this), "Redraw", canvas);

        await base.OnInitializedAsync();
    }



    private async Task OnClick(MouseEventArgs args)
    {
        Console.WriteLine(DrawOps);

        //Console.WriteLine("clicked on X:" + (mouseDownX));
        //Console.WriteLine("clicked on X:" + (mouseDownY));

        isClicked = true;
        await JS.InvokeVoidAsync("RequestAnimationFrame", DotNetObjectReference.Create(this), "Redraw", canvas);





    }

    private void OnMouseDown(MouseEventArgs args)
    {
        mouseDownX = (args.OffsetX/zoom-transX);
        mouseDownY = (args.OffsetY/zoom-transY);

        clickX = args.OffsetX;
        clickY = args.OffsetY;

        isMoving = true;

    }


    private async Task OnMouseMove(MouseEventArgs args)
    {
        if (isMoving & args.Buttons == 1)
        {

            transX = (args.OffsetX / zoom - mouseDownX);
            transY = (args.OffsetY / zoom - mouseDownY);

            await JS.InvokeVoidAsync("RequestAnimationFrame", DotNetObjectReference.Create(this), "Redraw", canvas);
        }
        else
        {
            isMoving = false;
        }

    }

    private async Task OnMouseWheel(WheelEventArgs args)
    {

        float deltaZoom = (float)(args.DeltaY * 0.0001f);
        zoom += deltaZoom;

        if (zoom < 0.25f)
        {
            zoom = 0.25f;
        }
        if (zoom > 2.0f)
        {
            zoom = 2.0f;
        }




        await JS.InvokeVoidAsync("RequestAnimationFrame", DotNetObjectReference.Create(this), "Redraw", canvas);

        Console.WriteLine("the buttons in the mouse wheeler"+args.Buttons);
    }




    [JSInvokable]
    public async Task Redraw()
    {
        // Console.WriteLine("hello from redraw");



        await JS.InvokeVoidAsync("Draw", canvas, await DrawOps, zoom, transX, transY, rotation, clickX, clickY, isClicked, DotNetObjectReference.Create(this), "OnMapClick");
        isClicked = false;
    }

    [JSInvokable]
    public async Task OnResize()
    {
        Console.WriteLine("hello resize");
        await JS.InvokeVoidAsync("RequestAnimationFrame", DotNetObjectReference.Create(this), "Redraw", canvas);
    }

    [JSInvokable]
    public async Task OnMapClick(string id)
    {
        Console.WriteLine("hello from OnMapClick:"+id);

        OnMachineClick.Invoke("Hello from ChildComponent id:"+id);
        //await JS.InvokeVoidAsync("RequestAnimationFrame", DotNetObjectReference.Create(this), "Redraw", canvas);
    }
}
